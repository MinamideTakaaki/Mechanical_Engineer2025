<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>HM-10 BLE Connect</title>
</head>
<body>
  <h1>HM-10 に接続するテストページ</h1>
  <button id="connectBtn">BLE に接続</button>
  <pre id="log"></pre>
  <button id="disconnectBtn">切断</button>

  <script>
    const log = (msg) => {
      document.getElementById('log').textContent += msg + "\n";
    };

    let device = null;

    document.getElementById('connectBtn').onclick = async () => {
      try {
        console.log("デバイス検索中...");
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "HM" }],
          optionalServices: ["0000ffe0-0000-1000-8000-00805f9b34fb"]
        });

        console.log("接続中: " + device.name);
        const server = await device.gatt.connect();

        const service = await server.getPrimaryService("0000ffe0-0000-1000-8000-00805f9b34fb");
        const characteristic = await service.getCharacteristic("0000ffe1-0000-1000-8000-00805f9b34fb");

        console.log("接続完了");

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          const value = new TextDecoder().decode(event.target.value);
          console.log("受信: " + value);
        });

        const sendText = "Hello from Web";
        await characteristic.writeValue(new TextEncoder().encode(sendText));
        console.log("送信: " + sendText);

      } catch (err) {
        console.log("エラー: " + err);
      }
    };

    document.getElementById('disconnectBtn').onclick = () => {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
        console.log("切断しました");
      } else {
        console.log("既に切断されています");
      }
    };
  </script>
</body>
</html>